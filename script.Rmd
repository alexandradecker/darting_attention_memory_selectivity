---
title: "Data from final NSYNC study"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

This script is for the analyses reported in the paper "Childrenâ€™s darting (not diffuse) attentional spotlight improves memory for irrelevant information" by Decker, Tandoc, Cho, Rebello, Mabbott, Duncan and Finn

```{r setwd}
# clear environment
rm(list = ls()) 
# load libraries
library(RColorBrewer); library(ggpubr); library(ggridges); library(cowplot); library(sjmisc); library(effects); library(hausekeep); library(data.table); library(tidyverse);library(TTR);library(imputeTS); library(roll); library(introdataviz); library(see); library(mediation); library(lme4); library(lmerTest);library(data.table); library(tidyverse); library(ppcor)

# ggplot theme
ggtheme = theme(plot.caption = element_text(hjust = -.2), 
                panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                panel.background = element_rect(fill = "white", colour = NA),
                axis.line.x = element_line(size = 1, linetype = "solid", colour = "black"), 
                axis.line.y = element_line(size = 1, linetype = "solid", colour = "black"),
                axis.text.x = element_text(size = 17, colour = 'grey24'), 
                axis.text.y = element_text(size = 17, colour = 'grey24'), 
                plot.title = element_text(size = 17, hjust = 0.5, face = "bold"),
                text = element_text(size = 17), panel.spacing.x = unit(1, "lines"),
                legend.key = element_blank(), legend.key.height = unit(2, 'line')) 
```

```{r load data}
nback <- fread("data/encoding.csv")
nback$nback_resp.rtRO <- NA
nback[, nback_resp.rtRO := nback_resp.rt]
nback[nback_resp.rtRO < 0.3, nback_resp.rtRO:= NA]
nback[, nback_resp.rtRO := outliersZ(nback_resp.rtRO, zCutOff = 3, digits = 5), by = subject]

rec = fread("data/recognition_final_test_cleaned.csv")
```


```{r remove bad blocks}
# as pre-registered, remove blocks where performance is particularly low from n-back and do not analyze those recognition blocks:
bad_blocks <- nback[!is.na(toRemoveBlock)]
nback <- nback[is.na(toRemoveBlock)]
```

##############################
####### Demographics #########
##############################

```{r demographics}
# compute age and sex:
age_df <- nback[, .(subject, age, group)]%>%unique()
pchisqr.df <- nback[, n_distinct(subject), by = .(nbackLevel, group)]
pchisqr.df[, proportion := V1/sum(V1), by = group]

# Create a contingency table
task_assignment <- matrix(c(15, 42, 46, 27), nrow = 2, byrow = TRUE)
rownames(task_assignment) <- c("Children", "Adults")
colnames(task_assignment) <- c("Task 1", "Task 2")

# Perform chi-square test
chi_square_result <- chisq.test(task_assignment)

# Print the result
print(chi_square_result)
```

######################################################
#### Age differences in n-back d' performance ########
######################################################

```{r model: group differences in n-back d'}
#load aggregated data nback d' data:
nback_dprime <- fread("data/nback_dprime.csv") 
nback_dprime[, n_distinct(subject), by = groupEC]
nback_dprime_category <- fread("data/nback_dprime_category.csv")

# mean d' by group:
nback_dprime[, mean(dprime), by = .(groupEC)]
nback_dprime[, summaryh(lm(dprime ~ groupEC))][term != '(Intercept)']

# Children are worse than adults at maintaining targets in working memory:
# by category:
nback_dprime_category[, summaryh(lmer(dprime ~  targetEC * groupEC + (1|subject)))][term != '(Intercept)']

# These effects do not interact with n-back level:
nback_dprime[, summaryh(lm(dprime ~ groupEC * nbackLevelEC))]
#nback_dprime_category[, summaryh(lmer(dprime ~  targetEC * groupEC * nbackLevelEC + (1|subject)))][term != '(Intercept)']
```

Figures focusing on d' performance on the n-back task: 
```{r Figures - group differences in n-back d'}
nback_dprime$group <- relevel(as.factor(nback_dprime$group), ref = "Adults")
# now using a stat summary plot:
ggplot(nback_dprime, aes(y = dprime,
       x = as.factor(nbackLevel), color=as.factor(group))) +
  stat_summary(fun.data = "mean_se", geom = "pointrange", 
               position = position_dodge(.175)) +
  scale_color_manual(values = c("darkseagreen","slateblue2")) +
ggtheme +
labs(title="N-back d' by age-group and level",
     x="N-back level", 
     y="N-back performance (d')", color = "")
```

```{r Figure - group differences in n-back d' by category}
# by target category:
nback_dprime_category$group <- relevel(as.factor(nback_dprime_category$group), ref  = "Adults")
nback_dprime_category$target2 <- relevel(as.factor(nback_dprime_category$target2), ref  = "objects")

# by target category:
ggplot(nback_dprime_category, aes(y = dprime,
       x = as.factor(target2), color=as.factor(group))) +
  stat_summary(fun.data = "mean_se", geom = "pointrange", 
               position = position_dodge(.5), size = 1) +
labs(x = "Target category", col = " ", y = "D'", fill = "") + 
  ggtheme + 
  scale_color_manual(values = c("darkseagreen4","slateblue2"))+
  scale_x_discrete(labels = c("Objects", "Faces")) +
  theme(legend.position = "bottom", legend.box = "horizontal", legend.margin = margin(t = 0, unit = "cm")) + 
  coord_cartesian(ylim = c(2.4, 3.7))
```

################################################
#### Age Differences in Selective Attention ####
################################################

```{r relevel variable and join n-back d' as a covariate}
nback[all_repeat_trials == "", all_repeat_trials := NA] # remove empty strings
nback$all_repeat_trials <- relevel(as.factor(nback$all_repeat_trials), ref = "lure repeat")
nback <- left_join(nback, nback_dprime[, .(subject, nback_dprime = dprime)])
nback <- as.data.table(nback)
```

Age group differences in distractor interference:
```{r Models: test for distractor interference across the sample:}
# Accuracy:
lure_interference_acc_cat <- glmer(acc ~ groupEC * lure_interferenceEC + nback_dprime + (lure_interferenceEC|subject), control = glmerControl(optimizer="bobyqa"), family = "binomial", data = nback[!is.na(nback_resp.rtRO) & !is.na(lure_interference)]); summaryh(lure_interference_acc_cat)

group_diff_interference_accuracy <- glmer(acc ~ groupEC * lure_interferenceEC + nback_dprime + (lure_interferenceEC|subject), family = "binomial", control = glmerControl(optimizer="bobyqa"), data = nback[!is.na(nback_resp.rtRO) & !is.na(lure_interference)]); summaryh(group_diff_interference_accuracy)

# RT
lure_interference_rt_log <- lmer(logRT ~ groupEC * lure_interferenceEC + nback_dprime + (lure_interferenceEC|subject), control = lmerControl(optimizer="bobyqa"), data = nback[acc == 1 & !is.na(nback_resp.rtRO)]); summaryh(lure_interference_rt_log)
```


RT Distractor interference separately in children and adults:
```{r}
# RT interference for children:
RT_Interference_Children <- lmer(logRT ~ groupDCc * lure_interferenceEC + nback_dprime + (lure_interferenceEC|subject), control = lmerControl(optimizer="bobyqa"), data = nback[acc == 1 & !is.na(nback_resp.rtRO)]); summaryh(RT_Interference_Children)

# RT interference for adults:
RT_Interference_Adults <- lmer(logRT ~ groupDCa * lure_interferenceEC + nback_dprime + (lure_interferenceEC|subject), control = lmerControl(optimizer="bobyqa"), data = nback[acc == 1 & !is.na(nback_resp.rtRO)]); summaryh(RT_Interference_Adults)
```

Exploratory (non-preregistered analyses) investigating age-group differences in RT and accuracy interference by category:
```{r}
# RT
RT_interference_category <- lmer(logRT ~ groupEC * lure_interferenceEC * targetEC + nback_dprime + (lure_interferenceEC|subject), control = lmerControl(optimizer="bobyqa"), data = nback[acc == 1 & !is.na(nback_resp.rtRO)]); summaryh(RT_interference_category)

# Accuracy 
Acc_interference_category <- glmer(acc ~ groupEC * lure_interferenceEC  * targetEC + nback_dprime + (lure_interferenceEC|subject), family = "binomial", control = glmerControl(optimizer="bobyqa"), data = nback[!is.na(nback_resp.rtRO) & !is.na(lure_interference)]); summaryh(Acc_interference_category)
```

Supplementary Analysis interograting age-group differences in distractor interference by category:
```{r}
# group differences in RT interference from objects
group_diff_interference_Rt_distractor_o <- lmer(logRT ~ groupEC * lure_interferenceEC * targetDCf + nback_dprime + (lure_interferenceEC|subject), control = lmerControl(optimizer="bobyqa"), data = nback[acc == 1 & !is.na(nback_resp.rtRO)]); summaryh(group_diff_interference_Rt_distractor_o)

# group differences in RT interference from faces
group_diff_interference_Rt_distractor_f <- lmer(logRT ~ groupEC * lure_interferenceEC * targetDCo + nback_dprime + (lure_interferenceEC|subject), control = lmerControl(optimizer="bobyqa"), data = nback[acc == 1 & !is.na(nback_resp.rtRO)]); summaryh(group_diff_interference_Rt_distractor_f)
```

Distractor interference separately for children and adults and separately by category:
```{r}
# children RT interference from objects:
summaryh(lmer(logRT ~ groupDCc * lure_interferenceEC * targetDCf + nback_dprime + (lure_interferenceEC|subject), control = lmerControl(optimizer="bobyqa"), data = nback[acc == 1 & !is.na(nback_resp.rtRO)]))

# children RT interference from faces:
summaryh(lmer(logRT ~ groupDCc * lure_interferenceEC * targetDCo + nback_dprime + (lure_interferenceEC|subject), control = lmerControl(optimizer="bobyqa"), data = nback[acc == 1 & !is.na(nback_resp.rtRO)]))

# adults RT interference from objects:
summaryh(lmer(logRT ~ groupDCa * lure_interferenceEC * targetDCf + nback_dprime + (lure_interferenceEC|subject), control = lmerControl(optimizer="bobyqa"), data = nback[acc == 1 & !is.na(nback_resp.rtRO)]))

# adults RT interference from faces:
summaryh(lmer(logRT ~ groupDCa * lure_interferenceEC * targetDCo + nback_dprime + (lure_interferenceEC|subject), control = lmerControl(optimizer="bobyqa"), data = nback[acc == 1 & !is.na(nback_resp.rtRO)]))
```


# Distractor Interference In Accuracy for adults:
```{r}
Interference_accuracy_adults <- glmer(acc ~ groupDCa * lure_interferenceEC  * targetEC + nback_dprime + (lure_interferenceEC|subject), family = "binomial", control = glmerControl(optimizer="bobyqa"), data = nback[!is.na(nback_resp.rtRO) & !is.na(lure_interference)]); summaryh(Interference_accuracy_adults)

#objects
Interference_accuracy_adults_objects <- glmer(acc ~ groupDCa * lure_interferenceEC  * targetDCf + nback_dprime + (lure_interferenceEC|subject), family = "binomial", control = glmerControl(optimizer="bobyqa"), data = nback[!is.na(nback_resp.rtRO) & !is.na(lure_interference)]); summaryh(Interference_accuracy_adults_objects)

#faces
Interference_accuracy_adults_faces <- glmer(acc ~ groupDCa * lure_interferenceEC  * targetDCo + nback_dprime + (lure_interferenceEC|subject), family = "binomial", control = glmerControl(optimizer="bobyqa"), data = nback[!is.na(nback_resp.rtRO) & !is.na(lure_interference)]); summaryh(Interference_accuracy_adults_faces)
```


# Distractor Interference In Accuracy for Children:
```{r}
# group differences:
group_diff_interference_accuracy <- glmer(acc ~ groupEC * lure_interferenceEC  * targetEC + nback_dprime + (lure_interferenceEC|subject), family = "binomial", control = glmerControl(optimizer="bobyqa"), data = nback[!is.na(nback_resp.rtRO) & !is.na(lure_interference)]); summaryh(group_diff_interference_accuracy)

# 
Accuracy_interference_children <- glmer(acc ~ groupDCc * lure_interferenceEC  * targetEC + nback_dprime + (lure_interferenceEC|subject), family = "binomial", control = glmerControl(optimizer="bobyqa"), data = nback[!is.na(nback_resp.rtRO) & !is.na(lure_interference)]); summaryh(Accuracy_interference_children)

#objects
Accuracy_interference_objects_children <- glmer(acc ~ groupDCc * lure_interferenceEC  * targetDCf + nback_dprime + (lure_interferenceEC|subject), family = "binomial", control = glmerControl(optimizer="bobyqa"), data = nback[!is.na(nback_resp.rtRO) & !is.na(lure_interference)]); summaryh(Accuracy_interference_objects_children)

#faces
Accuracy_interference_faces_children <- glmer(acc ~ groupDCc * lure_interferenceEC  * targetDCo + nback_dprime + (lure_interferenceEC|subject), family = "binomial", control = glmerControl(optimizer="bobyqa"), data = nback[!is.na(nback_resp.rtRO) & !is.na(lure_interference)]); summaryh(Accuracy_interference_faces_children)
```


#### Plot interference figures ####

```{r Figures: testing for age group differences in lure interference RT}
fread("data/selective_attention_rt.csv") -> nback_lure_interference_rt
fread("data/selective_attention_rt_category.csv") -> nback_lure_interference_rt_category

# plot the equivalent stat_summary() plot:
ggplot(nback_lure_interference_rt, aes(x = as.factor(group), y = lure_interference_rt, color=as.factor(group))) +
  stat_summary(fun.data = "mean_se", geom = "pointrange", show.legend = F, 
               position = position_dodge(.5), size = 1) +
  scale_color_manual(values = c("darkseagreen4","slateblue2")) +
ggtheme +
labs(x = "Age Group", fill = "", y = 'RT Interference')  + 
  geom_hline(yintercept = 0, color = 'gray', linetype = "dashed") + 
  coord_cartesian(ylim = c(-0.008, .05)) + 
  scale_y_continuous(breaks = seq(0, .04, by = .02)) 

# relevel so Objects are the base target category:
nback_lure_interference_rt_category$distractor_category <- relevel(as.factor(nback_lure_interference_rt_category$distractor_category), ref = "objects")

# by category using state_summay:
ggplot(nback_lure_interference_rt_category, aes(x = as.factor(distractor_category), y = lure_interference_rt, color=as.factor(group))) +
  stat_summary(fun.data = "mean_se", geom = "pointrange", show.legend = F, 
               position = position_dodge(.5), size = 1) +
  scale_color_manual(values = c("darkseagreen4","slateblue2")) +
  scale_x_discrete(labels = c("Objects", "Faces")) +
ggtheme +
labs(x = "Distractor Category", y = 'RT Interference')  + 
  geom_hline(yintercept = 0, color = 'gray', linetype = "dashed") +
  coord_cartesian(ylim = c(-0.02, 0.075)) 


# individual difference scores
fread("data/selective_attention_acc.csv") -> nback_lure_interference_acc


# do the dot plot version wtih stat_summary():
  ggplot(nback_lure_interference_acc, aes(x = as.factor(group), y = lure_interference_acc, color=as.factor(group))) +
  stat_summary(fun.data = "mean_se", geom = "pointrange", show.legend = F, 
               position = position_dodge(.5), size = 1) +
  scale_color_manual(values = c("darkseagreen4","slateblue2")) +
ggtheme +
labs(x = "Age Group", y = 'Accuracy Interference')  + 
  geom_hline(yintercept = 0, color = 'gray', linetype = "dashed") +
  coord_cartesian(ylim = c(-0.0, 0.065))

fread("data/selective_attention_category_acc.csv") -> nback_lure_interference_cat_acc

# now use stat_summary():
ggplot(nback_lure_interference_cat_acc, aes(x = group, y = lure_interference_acc, color=as.factor(distractor_category)))+
  stat_summary(fun.data = "mean_se", geom = "pointrange", 
               position = position_dodge(.5), size = 1) +
  scale_color_manual(values = c("darkred", "darkslateblue"), labels = c("Faces", "Objects")) +
  scale_x_discrete(labels = c("Adults", "Children")) +
ggtheme +
labs(x = "Distractor Category", y = 'Accuracy Interference', color = "")  + 
  geom_hline(yintercept = 0, color = 'gray', linetype = "dashed") + 
  coord_cartesian(ylim = c(-0.0, 0.11))

nback_lure_interference_cat_acc$distractor_category <- relevel(as.factor(nback_lure_interference_cat_acc$distractor_category), ref = "objects")
# do the dot plot version with stat_summary(): 
ggplot(nback_lure_interference_cat_acc, aes(x = as.factor(distractor_category), y = lure_interference_acc, color=group))+
  stat_summary(fun.data = "mean_se", geom = "pointrange", 
               position = position_dodge(.5), size = 1) +
  scale_color_manual(values = c("darkseagreen4","slateblue2")) +
  scale_x_discrete(labels = c("Objects", "Faces")) +
ggtheme +
labs(x = "Distractor Category", y = 'Accuracy Interference')  + 
  geom_hline(yintercept = 0, color = 'gray', linetype = "dashed") + 
  theme(legend.position = "none") + 
  coord_cartesian(ylim = c(-0.02, 0.125))
```


##################################################
### Age group differences in memory selectivity###
##################################################

Load Memory Data:
```{r}
fread("data/overall_dprime_mem.csv") -> overall_dprime_mem
fread("data/dprime_by_cat.csv") -> dprime_by_cat

# add n-back d prime as a covariate:
left_join(overall_dprime_mem, nback_dprime[, .(subject, nback_dprime = dprime)]) -> overall_dprime_mem
left_join(dprime_by_cat, nback_dprime[, .(subject, nback_dprime = dprime)]) -> dprime_by_cat # add nback dprime:

fread("data/mem_selectivity_dprime_long.csv") -> mem_selectivity_long
mem_selectivity_long$nback_dprime <- NULL # remove nback dprime from the model

# add nback d' to the model:
left_join(mem_selectivity_long, nback_dprime[, .(subject, nback_dprime = dprime)]) -> mem_selectivity_long

# create a variable reflectings n-back level:
mem_selectivity_long[, nbackLevelDC1 := ifelse(nbackLevel == 1, 0,1)]
mem_selectivity_long[, nbackLevelDC2 := ifelse(nbackLevel == 2, 0,1)]
```

Recognition memory performance did not differ between children and adults:
```{r}
dprime_by_cat[, summaryh(lmer(d ~ categoryEC * groupEC + nback_dprime + (1|subject)))]
dprime_by_cat[, groupDCa := ifelse(group == "Adults", 0, 1)]
dprime_by_cat[, groupDCc := ifelse(group == "Children", 0, 1)]
dprime_by_cat[, summaryh(lmer(d ~ categoryDCf * groupEC + nback_dprime + (1|subject)))]
```

Regardless of age, participants are better at remembering targets than distractors; however, memory selectivity was reduced in children compared to adults:
```{r}
mem_selectivity_long[, summaryh(lm(dprime ~ groupEC * dprimeTypeEC + nback_dprime + (1|subject)))]
```

Comparing children and adults, separately for memories of targets vs. distractors:
```{r}
# Age group differences in memory for targets:
mem_selectivity_long[, summaryh(lm(dprime ~ groupEC * dprimeTypeDCt + nback_dprime + (1|subject)))]

# Age group differences in memory for distractors:
mem_selectivity_long[, summaryh(lm(dprime ~ groupEC * dprimeTypeDCd + nback_dprime + (1|subject)))]
```

Testing whether nback level moderates the relationship between age group differences in d':
```{r}
mem_selectivity_long[, summaryh(lm(dprime ~ groupEC * dprimeTypeEC * nbackLevelEC + nback_dprime + (1|subject)))]

fread("data/d_memory_selectivity_category_long.csv") -> mem_selectivity_by_cat_long
mem_selectivity_by_cat_long[, nbackLevelEC := ifelse(nbackLevel == 1, -1, 1)]
mem_selectivity_by_cat_long[, summaryh(lmer(dprime ~ trialtypeEC * groupEC * categoryEC *nbackLevelEC + nback_dprime + (1|subject)))][term != '(Intercept)']
```

```{r Figures - memory selectivity}
ggplot(mem_selectivity_long, aes(as.factor(dprimeType), dprime, col = as.factor(group))) +
  stat_summary(fun.data = "mean_ci", geom = "pointrange", 
               position = position_dodge(.5), size = 1) +
ggtheme  +
  labs(x = " ", col = "Trial type", y = "D'") +
  scale_color_manual(values = c("darkseagreen4","slateblue2")) +
  scale_x_discrete(labels = c("Targets", "Distractors")) 
```

Test whether group differences in memory selectivity differed by category:
```{r }
mem_selectivity_by_cat_long[, summaryh(lmer(dprime ~ trialtypeEC * groupEC * categoryEC  + nback_dprime + (1|subject)))][term != '(Intercept)']
mem_selectivity_by_cat_long[, summaryh(lmer(dprime ~ trialtypeEC * groupEC * categoryEC  * nbackLevelEC + nback_dprime + (1|subject)))][term != '(Intercept)']

# mean d' for faces:
mem_selectivity_by_cat_long[category == 'face', mean(dprime, na.rm=T), by = .(trialtype)]

# face distractors:
mem_selectivity_by_cat_long[category == 'face' & trialtypeEC == -1 & !is.na(dprime), n_distinct(subject), by = group]
mem_selectivity_by_cat_long[category == 'face' & dprime <0 & trialtypeEC == -1& !is.na(dprime), n_distinct(subject), by = group]

# face targets:
mem_selectivity_by_cat_long[category == 'face' & trialtypeEC == 1 & !is.na(dprime), n_distinct(subject), by = group]
mem_selectivity_by_cat_long[category == 'face' & dprime <0 & trialtypeEC == 1& !is.na(dprime), n_distinct(subject), by = group]
```


Memory selectivity differences for objects, separately by target and distractor:
```{r}
# memory selectivity in children for objects
mem_selectivity_by_cat_long[, summaryh(lmer(dprime ~ trialtypeEC * groupEC * categoryEC  + nback_dprime + (1|subject)))][term != '(Intercept)']

# memory selectivity in adults for objects
mem_selectivity_by_cat_long[, summaryh(lmer(dprime ~ trialtypeEC * groupDCa * categoryDCo  + nback_dprime + (1|subject)))][term != '(Intercept)']

# memory selectivity age differences for objects:
mem_selectivity_by_cat_long[, summaryh(lmer(dprime ~ trialtypeEC * groupEC * categoryDCo  + nback_dprime + (1|subject)))][term != '(Intercept)']

# compare target object memory in children vs. adults:
mem_selectivity_by_cat_long[, summaryh(lmer(dprime ~ trialtypeECt * groupEC * categoryDCo  + nback_dprime + (1|subject)))][term != '(Intercept)']

# compare distractor memory in children vs. adults for objects:
mem_selectivity_by_cat_long[, summaryh(lmer(dprime ~ trialtypeDCd * groupEC * categoryDCo  + nback_dprime + (1|subject)))][term != '(Intercept)']
mem_selectivity_by_cat_long[, summaryh(lmer(dprime ~ trialtypeEC * groupEC * categoryDCo  * nback_dprime + (1|subject)))][term != '(Intercept)']
```

Memory selectivity differences for faces, separately by target and distractor:
```{r}
# memory selectivity in adults for faces
mem_selectivity_by_cat_long[, summaryh(lmer(dprime ~ trialtypeEC * groupDCa * categoryDCf  + nback_dprime + (1|subject)))][term != '(Intercept)']

# memory selectivity in children for faces
mem_selectivity_by_cat_long[, summaryh(lmer(dprime ~ trialtypeEC * groupDCc * categoryDCf  + nback_dprime + (1|subject)))][term != '(Intercept)']

# memory selectivity age differences for faces:
mem_selectivity_by_cat_long[, summaryh(lmer(dprime ~ trialtypeEC * groupEC * categoryDCf  + nback_dprime + (1|subject)))][term != '(Intercept)']
```


##########################################################################
#### Relationships between Selective Attention and Memory Selectivity ####
##########################################################################

```{r join data: correlating memory selectivity with distracter interference}
fread("data/mem_selectivity_attention_data.csv") -> mem_selectivity_wide
```

Correlate lure interference with memory selectivity:
```{r}
# lure interference accuracy and memory selectivity:
mem_selectivity_wide[, summaryh(lm(memory_selectivity ~ lure_interference_acc + nback_dprime))]

# lure interference in RT and memory selectivity:
mem_selectivity_wide[, summaryh(lm(memory_selectivity ~ lure_interference_rt  + nback_dprime))]
```

Correlate lure interference from objects with memory selectivity for objects:
```{r figures and models for relationship between interference and memory selectivity}
# lure interference accuracy and memory selectivity:
mem_selectivity_wide[, summaryh(lm(memory_selectivity_objects ~ interference_acc_objects + nback_dprime))]

# lure interference in RT and memory selectivity:
mem_selectivity_wide[, summaryh(lm(memory_selectivity_objects ~ object_interference_rt  + nback_dprime))]
```

Figures:
```{r}
# figure for group interactions
ggplot(mem_selectivity_wide,aes(lure_interference_rt, memory_selectivity, color = as.factor(group)))+ 
  stat_smooth(formula = y ~ x, method = 'lm') + 
  geom_point(alpha = 0.5) +
  labs(y = "Memory Selectivity", x = "Distractor Interference in RT") +
  scale_color_manual(values = c("darkseagreen4","slateblue2")) +
  # put legend on bottom:
  coord_cartesian(ylim = c(-1.3, 2.7)) +
  theme(legend.position = 0) + ggtheme

# across the sample:
ggplot(mem_selectivity_wide,aes(lure_interference_rt, memory_selectivity)) + 
  stat_smooth(formula = y ~ x, method = 'lm') + 
  geom_point(alpha = 0.5) +
  labs(y = "Memory Selectivity", x = "Distractor Interference (RT)") + 
  ggtheme

# object images only:
ggplot(mem_selectivity_wide,aes(object_interference_rt, memory_selectivity_objects)) + 
  stat_smooth(formula = y ~ x, method = 'lm') + 
  geom_point(alpha = 0.5) +
  coord_cartesian(xlim = c(-.23, .27)) +
  labs(y = "Memory Selectivity", x = "Distractor Interference (RT)") + ggtheme
```


mediation model for lure interference RT across all trials 
```{r}
#acme: mediated (ab) effect
#ade: direct effect (c')
#total effect: c

# pre-registered model: does not control for n-back d':
model.y_all =  lm(memory_selectivity ~ groupEC + lure_interference_rt , data = mem_selectivity_wide[!is.na(lure_interference_rt) & !is.na(memory_selectivity)])
summary(model.y_all)
model.m_all = lm(lure_interference_rt ~ groupEC , data = mem_selectivity_wide[!is.na(lure_interference_rt) & !is.na(memory_selectivity)])
summary(model.m_all)
model.mediate = mediate(model.m_all, model.y_all, sims = 5000, treat = 'groupEC', mediator = 'lure_interference_rt', boot = TRUE)
summary(model.mediate)
source( "http://page-gould.com/scripts/r/mediations_patch.r") # Needed to update the mediations function
standard.errors(model.mediate)

# non-pre-registered model: controls for n-back d' to isolate the effects of distractor interference
model.y_all =  lm(memory_selectivity ~ groupEC + lure_interference_rt  + nback_dprime, data = mem_selectivity_wide[!is.na(lure_interference_rt) & !is.na(memory_selectivity)])
summary(model.y_all)
model.m_all = lm(lure_interference_rt ~ groupEC + nback_dprime, data = mem_selectivity_wide[!is.na(lure_interference_rt) & !is.na(memory_selectivity)])
summaryh(model.m_all)
model.mediate = mediate(model.m_all, model.y_all, sims = 5000, treat = 'groupEC', mediator = 'lure_interference_rt', boot = TRUE)
summary(model.mediate)
source( "http://page-gould.com/scripts/r/mediations_patch.r") # Needed to update the mediations function
standard.errors(model.mediate)
```

For objects specifically:
```{r}
# pre-registered approach (doesn't control for nback d'): 
model.y_all =  lm(memory_selectivity_objects ~ groupEC + object_interference_rt, data = mem_selectivity_wide[!is.na(object_interference_rt) & !is.na(memory_selectivity_objects)])
summary(model.y_all)
model.m_all = lm(object_interference_rt ~ groupEC, data = mem_selectivity_wide[!is.na(object_interference_rt) & !is.na(memory_selectivity_objects)])
summary(model.m_all)
model.mediate = mediate(model.m_all, model.y_all, sims = 5000, treat = 'groupEC', mediator = 'object_interference_rt', boot = TRUE)
summary(model.mediate)
source( "http://page-gould.com/scripts/r/mediations_patch.r") # Needed to update the mediations function
standard.errors(model.mediate)

# non-pre-registered aproach: controls for n-back d' to isolate the effects of distractor interference
model.y_all =  lm(memory_selectivity_objects ~ groupEC + object_interference_rt + nback_dprime, data = mem_selectivity_wide[!is.na(object_interference_rt) & !is.na(memory_selectivity_objects)])
summary(model.y_all)

model.m_all = lm(object_interference_rt ~ groupEC+ nback_dprime, data = mem_selectivity_wide[!is.na(object_interference_rt) & !is.na(memory_selectivity_objects)])
summaryh(model.m_all)

model.mediate = mediate(model.m_all, model.y_all, sims = 5000, treat = 'groupEC', mediator = 'object_interference_rt', covariates = "nback_dprime", boot = TRUE)
summary(model.mediate)
source( "http://page-gould.com/scripts/r/mediations_patch.r") # Needed to update the mediations function
standard.errors(model.mediate)
```



Contingency analysis:
Notes: 
- recognition memory trials where rt < 0.3 are removed
- many recognition trials have a for EITHER a target OR a distractor becuase the n-back trial had a repeat (and we did not test memory for repeats)
- this means the total number of trials included in the contingency anlaysis is smaller than the total number of trials tested at recognition

```{r}
# load data
contingency_table_analysis = fread("data/aggregate_contingency_table_analysis.csv")
contingency_table_analysis_cat = fread("data/aggregate_contingency_table_analysis_cat.csv")
```

# Does memory for distractors depend on memory for target (whether the target was remembered or forgotten?). Does this interact with age group?
```{r models}
#testing whether distractor memory depends on whether a target was remembered or forgotten:
contingency_table_analysis[, summaryh(lmer(memory_hits_distracter ~ target_memoryEC * groupEC + nback_dprime + (1|subject)))][term != "(Intercept)"]

# effect in children:
contingency_table_analysis[, summaryh(lmer(memory_hits_distracter ~ target_memoryEC * groupDCc + nback_dprime + (1|subject)))][term != "(Intercept)"]

# effect in adults:
contingency_table_analysis[, summaryh(lmer(memory_hits_distracter ~ target_memoryEC * groupDCa + nback_dprime + (1|subject)))][term != "(Intercept)"]

# by category:
contingency_table_analysis_cat[, categoryEC := ifelse(category == "object", 1, -1)]
contingency_table_analysis_cat[, categoryDCo := ifelse(category == "object", 0, 1)]
contingency_table_analysis_cat[, categoryDCf := ifelse(category == "face", 0, 1)]

# does the effect differ by category:
contingency_table_analysis_cat[, summaryh(lmer(memory_hits_distracter ~ target_memoryEC * groupEC * categoryEC + nback_dprime + (1|subject)))][term != "(Intercept)"]

# in children:
contingency_table_analysis_cat[, summaryh(lmer(memory_hits_distracter ~ target_memoryEC * categoryEC  * groupDCc + (1|subject)))][term != "(Intercept)"]

#in adults:
contingency_table_analysis_cat[, summaryh(lmer(memory_hits_distracter ~ target_memoryEC * categoryEC * groupDCa + nback_dprime + (1|subject)))][term != "(Intercept)"]

# faces in adults
contingency_table_analysis_cat[, summaryh(lmer(memory_hits_distracter ~ target_memoryEC * categoryDCf * groupDCa + nback_dprime + (1|subject)))][term != "(Intercept)"]

# faces in children
contingency_table_analysis_cat[, summaryh(lmer(memory_hits_distracter ~ target_memoryEC * categoryDCf* groupDCc + nback_dprime + (1|subject)))][term != "(Intercept)"]
```

Plot figure:
```{r}
ggplot(contingency_table_analysis, 
       aes(group, memory_hits_distracter*100, col =as.factor(target_memory2))) + 
  #geom_jitter() + 
  ggtheme +
  stat_summary(position = position_dodge(0.5), size = 1)  +
  labs(y = "% Distractors Remembered") +
  labs(x = "") +
  scale_color_manual(values = c('deeppink4', 'deeppink'), labels = c("Target Forgotten", "Target Remembered")) +
  theme(legend.title = element_blank(), legend.position = "bottom") +
  coord_cartesian(ylim = c(36, 53)) 
```


######## Recognition memory manipulation ###########
Are people faster to endorse target as old if preceded by paired distractor?

```{r Paired analysis - are correctly primed distracters recognized faster?}
# everyone - for all types
rec[trialtype == 'distracter_name' & mem_resp.corr == 1 & !is.na(mem_resp.rtRO), summaryh(lmer(logRT ~ orderingEC * categoryEC * groupEC + nback_dprime+  (categoryEC |subject)))][term != "(Intercept)"]

# for object distractors:
rec[trialtype == 'distracter_name' & mem_resp.corr == 1 & !is.na(mem_resp.rtRO), summaryh(lmer(logRT ~ orderingEC * categoryDCo * groupEC + nback_dprime+  (categoryDCo |subject)))][term != "(Intercept)"]

# for face distractors:
rec[trialtype == 'distracter_name' & mem_resp.corr == 1 & !is.na(mem_resp.rtRO), summaryh(lmer(logRT ~ orderingEC * categoryDCf * groupEC + nback_dprime+  (categoryDCf|subject)))][term != "(Intercept)"]


#adults
rec[trialtype == 'distracter_name' & mem_resp.corr == 1 & !is.na(mem_resp.rtRO), summaryh(lmer(logRT ~ orderingEC * categoryDCo * groupDCa + nback_dprime +  (categoryDCo |subject)))][term != "(Intercept)"]

# children
rec[trialtype == 'distracter_name' & mem_resp.corr == 1 & !is.na(mem_resp.rtRO), summaryh(lmer(logRT ~ orderingEC * categoryDCo * groupDCc + nback_dprime +  (categoryDCo |subject)))][term != "(Intercept)"]


# objects#
# everyone
rec[trialtype == 'distracter_name' & ordering %in% c('correctly paired', 'incorrectly paired') & mem_resp.rt > 0.3 & mem_resp.corr == 1 & !is.na(mem_resp.rtRO) & category=='object', summaryh(lmer(logRT ~ orderingEC * groupEC  + nback_dprime +  (1|subject)))][term != "(Intercept)"]

# adults
rec[trialtype == 'distracter_name' & ordering %in% c('correctly paired', 'incorrectly paired') & mem_resp.rt > 0.3 & mem_resp.corr == 1 & !is.na(mem_resp.rtRO) & category=='object', summaryh(lmer(logRT ~ orderingEC * groupDCa  + nback_dprime +  (1|subject)))][term != "(Intercept)"]

rec[trialtype == 'distracter_name' & ordering %in% c('correctly paired', 'incorrectly paired') & mem_resp.rt > 0.3 & mem_resp.corr == 1 & !is.na(mem_resp.rtRO) & category=='object', summaryh(lmer(logRT ~ orderingEC * groupDCc  + nback_dprime +  (1|subject)))][term != "(Intercept)"]
```

```{r Paired analysis by category - are correctly primed distracters recognized faster?}
rt_priming_rec <- rec[trialtype == 'distracter_name'   
           & mem_resp.rt > 0.3 & !is.na(mem_resp.rtRO) & mem_resp.corr == 1 & category == "object" & ordering %in% c('correctly paired', 'incorrectly paired'),
           .(mean_rt = mean(logRT, na.rm=T)), by = .(subject, ordering, group)]

ggplot(rt_priming_rec, aes(group, mean_rt, col = ordering)) + 
  #geom_jitter(alpha = 0.2) + 
  ggtheme +
  #geom_jitter(alpha = 0.5) +
  stat_summary(position = position_dodge(0.5), size =1)+
  labs(y= "Log RT (Seconds)", color = "", x = "")  +
  scale_color_manual(values = c("navyblue", "olivedrab4"),         
                     labels = c("Correctly Paired", "Incorrectly Paired")) + 
  theme(legend.position = "bottom") + 
  coord_cartesian(ylim = c(.4, .9))


rt_priming_rec.summarized <- seWithin(data = rt_priming_rec, measurevar = "mean_rt", betweenvars = c("group"), withinvars = c("ordering"), idvar = "subject")

ggplot(rt_priming_rec.summarized, aes(group, mean_rt, col = ordering)) + 
  #geom_jitter(alpha = 0.2) + 
  ggtheme +
  #geom_jitter(alpha = 0.5) +
  geom_point(position = position_dodge(width = 0.5), size = 4)+
  geom_errorbar(aes(ymin = mean_rt - se, ymax = mean_rt + se), position = position_dodge(width = 0.5), width = 0, size = 0.7)+
  labs(y= "Log RT (Seconds)", color = "", x = "")  +
  scale_color_manual(values = c("navyblue", "olivedrab4"),         
                     labels = c("Correctly Paired", "Incorrectly Paired")) + 
  theme(legend.position = "none") + 
  coord_cartesian(ylim = c(.4, .9))

ggplot(rt_priming_rec.summarized, aes(group, mean_rt, col = ordering)) + 
  #geom_jitter(alpha = 0.2) + 
  ggtheme +
  #geom_jitter(alpha = 0.5) +
  geom_point(position = position_dodge(width = 0.5), size = 3)+
  geom_errorbar(aes(ymin = mean_rt - se, ymax = mean_rt + se), position = position_dodge(width = 0.5), width = 0, size = 1)+
  labs(y= "Log RT (Seconds)", color = "", x = "")  +
  scale_color_manual(values = c("navyblue", "olivedrab4", "palevioletred"), labels = c("Correctly Paired", "Incorrectly Paired", "Unpaired"))

ggplot(rt_priming_rec, aes(group, mean_rt, col = ordering)) + 
  #geom_jitter(alpha = 0.2) + 
  ggtheme +
  #geom_jitter(alpha = 0.5) +
  stat_summary(position = position_dodge(0.5), size =1)+
  labs(y= "Log RT", title = "")  +
  scale_color_manual(values = c("navyblue", "olivedrab4"),         
                   labels = c("correctly paired", "incorrectly paired"))  + 
  coord_cartesian(ylim = c(0.4, 0.88))
```


```{r}
# overall model:
rec[trialtype == 'distracter_name' & mem_resp.rt > 0.3 & !is.na(orderingEC), summaryh(glmer(mem_resp.corr ~ orderingEC * groupEC * categoryEC + nback_dprime +  (categoryEC|subject), family = "binomial"))][term != "(Intercept)"]

# object distractors::
rec[trialtype == 'distracter_name' & mem_resp.rt > 0.3 & !is.na(orderingEC), summaryh(glmer(mem_resp.corr ~ orderingEC * groupDCc * categoryDCo + nback_dprime +  (categoryEC|subject), family = "binomial"))][term != "(Intercept)"]

rec[trialtype == 'distracter_name' & mem_resp.rt > 0.3 & !is.na(orderingEC), summaryh(glmer(mem_resp.corr ~ orderingEC * groupDCa * categoryDCo + nback_dprime +  (categoryEC|subject), family = "binomial"))][term != "(Intercept)"]

# face distractors:
rec[trialtype == 'distracter_name' & mem_resp.rt > 0.3 & !is.na(orderingEC), summaryh(glmer(mem_resp.corr ~ orderingEC * groupDCc * categoryDCf + nback_dprime +  (categoryEC|subject), family = "binomial"))][term != "(Intercept)"]

rec[trialtype == 'distracter_name' & mem_resp.rt > 0.3 & !is.na(orderingEC), summaryh(glmer(mem_resp.corr ~ orderingEC * groupDCa * categoryDCf + nback_dprime +  (1|subject), family = "binomial"))][term != "(Intercept)"]

rec[trialtype == 'distracter_name'& mem_resp.rt > 0.3 & !is.na(orderingEC) & mem_resp.rtRO > 0.3, summaryh(glmer(mem_resp.corr ~ orderingEC * groupDCc  + nback_dprime +  (1|subject), family = "binomial"))][term != "(Intercept)"]

rec[trialtype == 'distracter_name' & mem_resp.rt > 0.3 & !is.na(orderingEC), summaryh(glmer(mem_resp.corr ~ orderingEC * groupDCa * categoryEC + nback_dprime +  (1|subject), family = "binomial"))][term != "(Intercept)"]

rec[trialtype == 'distracter_name' & mem_resp.rt > 0.3 & !is.na(orderingEC), summaryh(glmer(mem_resp.corr ~ orderingEC * groupDCc  + nback_dprime +  (1|subject), family = "binomial"))][term != "(Intercept)"]

rec[trialtype == 'distracter_name' & mem_resp.rt > 0.3 & !is.na(orderingEC), summaryh(glmer(mem_resp.corr ~ orderingEC * category + nback_dprime +  (1|subject), family = "binomial")), by = group][term != "(Intercept)"]

rec[trialtype == 'distracter_name' & mem_resp.rt > 0.3 & !is.na(orderingEC), summaryh(glmer(mem_resp.corr ~ orderingEC * groupDCa  + nback_dprime +  (1|subject), family = "binomial"))][term != "(Intercept)"] 


# plot with summarized data:
to_plot_acc_ordering <- rec[trialtype == 'distracter_name' & !is.na(mem_resp.rtRO) & !is.na(orderingEC), .(mem_resp.corr = mean(mem_resp.corr)), by = .(subject, group, ordering, category)] 

 rec[trialtype == 'distracter_name', .N, by = .(subject, category)]
  rec[trialtype == 'distracter_name', mean(mem_resp.corr), by = .(subject, category, group)][, mean(V1), by = .(category, group)]

rec[ordering == 'new', mean(mem_resp.corr), by = .(subject, category, group)][, mean(V1), by = .(category, group)]

to_plot_acc_ordering <- rec[trialtype == 'distracter_name' & !is.na(mem_resp.rtRO) & !is.na(orderingEC), .(mem_resp.corr = mean(mem_resp.corr)), by = .(subject, group, ordering, category)] 

ggplot(to_plot_acc_ordering, 
       aes(as.factor(group), mem_resp.corr, col = as.factor(ordering))) +
  #geom_jitter(alpha = 0.2) +
  stat_summary(position = position_dodge(0.5)) +
  # confidence intervals rather than se:
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0, position = position_dodge(0.5)) + 
  ggtheme +
  labs(y = "Proportion Correct", x = "Group", color = "Ordering") +
  scale_color_manual(values = c("navyblue", "olivedrab4"),         
                     labels = c("Correctly paired", "Incorrectly paired"))  + 
  facet_wrap(~category, ncol = 2) + 
  coord_cartesian(ylim = c(0.30, 0.59))
```

```{r RT analysis for objects and faces - which is faster?}
mean_rt_by_cat <- rec[ mem_resp.rt > 0.3 & correct_answer_mem == "old" , .(rt = mean(logRT, na.rm=T)), by = .(subject, group, category, block_num_rec)]

mean_rt_by_cat[]%>%
  ggplot(aes(group, rt, col = category)) + 
  #geom_jitter(alpha = 0.2) + 
  stat_summary(position = position_dodge(0.5)) + 
  ggtheme + 
  labs(y = "rt mean centered \n outlier trials at 3 sd excluded", title = "")

mean_rt_by_cat[]%>%
  ggplot(aes(group, rt, col = category)) + 
  geom_jitter(alpha = 0.2) + 
  stat_summary(position = position_dodge(0.5)) + 
  ggtheme +
  facet_wrap(~block_num_rec) + 
  labs(y = "NOT mean centered \n outlier trials at 3 sd excluded", title = "")
```

```{r}

```

